name: Generate Resume PDF

on:
  pull_request:
    branches: [main]

jobs:
  generate-pdf:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}
          fetch-depth: 0

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y pandoc weasyprint

      - name: Remove ToC
        run: |
          # Remove the Table of Contents section
          sed -i '/^#### Table of Contents/,/^## /{/^## /!d}' README.md

      - name: Generate full PDF
        run: |
          pandoc README.md \
            -f markdown \
            -t html \
            --metadata pagetitle="RJ Hollberg - Resume" \
            --css=pdf-styles.css \
            --embed-resources \
            --standalone \
            -o Resume_Full.pdf \
            --pdf-engine=weasyprint

      - name: Trim old Data
        run: |
          # Replace print-cutoff marker with a note, then delete everything after
          sed -i 's/<!-- print-cutoff -->/*Additional experience (1999â€“2013) available at [https:\/\/taffareljr.github.io\/resume](https:\/\/taffareljr.github.io\/resume)*/' README.md
          sed -i '/^### Centershift/,$d' README.md

      - name: Generate brief PDF
        run: |
          pandoc README.md \
            -f markdown \
            -t html \
            --metadata pagetitle="RJ Hollberg - Resume" \
            --css=pdf-styles.css \
            --embed-resources \
            --standalone \
            -o Resume_Brief.pdf \
            --pdf-engine=weasyprint

      - name: Restore README.md
        run: |
          git checkout README.md

      - name: Commit PDFs to PR branch
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Resume_Full.pdf Resume_Brief.pdf
          if git diff --staged --quiet; then
            echo "No changes to PDFs"
          else
            git commit -m "Generate Resume PDFs from README.md"
            git push
          fi
